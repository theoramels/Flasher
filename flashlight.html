<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<title>Morse Flashlight</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: #0a0a0f;
    color: #e0e0e0;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }
  header {
    text-align: center;
    padding: 24px 16px 12px;
  }
  header h1 { font-size: 1.6rem; letter-spacing: 2px; color: #fff; }
  header p { font-size: 0.8rem; color: #888; margin-top: 4px; }

  .tabs {
    display: flex;
    margin: 0 16px;
    border-radius: 12px;
    overflow: hidden;
    background: #1a1a2e;
  }
  .tab {
    flex: 1; padding: 12px; text-align: center;
    cursor: pointer; font-size: 0.95rem; font-weight: 600;
    color: #888; transition: all 0.2s;
    border: none; background: transparent;
  }
  .tab.active { background: #4f8ef7; color: #fff; border-radius: 12px; }

  .panel { display: none; padding: 20px 16px; flex-direction: column; gap: 16px; }
  .panel.active { display: flex; }

  textarea {
    width: 100%; padding: 14px; border-radius: 12px;
    background: #1a1a2e; border: 1px solid #2a2a4a;
    color: #fff; font-size: 1rem; resize: none; height: 100px;
    outline: none;
  }
  textarea:focus { border-color: #4f8ef7; }

  .morse-display {
    background: #1a1a2e; border-radius: 12px; padding: 14px;
    font-family: monospace; font-size: 1.1rem; letter-spacing: 3px;
    color: #4f8ef7; min-height: 50px; word-break: break-all;
    line-height: 1.8;
  }

  .speed-row {
    display: flex; align-items: center; gap: 12px;
  }
  .speed-row label { font-size: 0.85rem; color: #888; white-space: nowrap; }
  input[type=range] { flex: 1; accent-color: #4f8ef7; }

  button.main-btn {
    padding: 16px; border-radius: 14px; border: none;
    font-size: 1.1rem; font-weight: 700; cursor: pointer;
    transition: all 0.15s; width: 100%;
  }
  .btn-send { background: #4f8ef7; color: #fff; }
  .btn-send:active { background: #2d6ed6; }
  .btn-send:disabled { background: #2a2a4a; color: #555; cursor: default; }
  .btn-stop { background: #e74c3c; color: #fff; }
  .btn-receive { background: #2ecc71; color: #fff; }
  .btn-receive.recording { background: #e74c3c; }

  .status-dot {
    width: 12px; height: 12px; border-radius: 50%;
    background: #333; display: inline-block; margin-right: 8px;
    transition: background 0.1s;
  }
  .status-dot.on { background: #ffe066; box-shadow: 0 0 10px #ffe066; }

  .status-bar {
    display: flex; align-items: center; padding: 10px 14px;
    background: #1a1a2e; border-radius: 10px; font-size: 0.9rem;
  }

  #receive-output {
    background: #1a1a2e; border-radius: 12px; padding: 14px;
    min-height: 80px; font-size: 1.1rem; color: #2ecc71;
    word-break: break-word; line-height: 1.7;
  }
  #receive-morse {
    background: #1a1a2e; border-radius: 12px; padding: 14px;
    font-family: monospace; font-size: 1rem; color: #888;
    min-height: 40px; word-break: break-all; letter-spacing: 2px;
  }

  .hint { font-size: 0.78rem; color: #555; text-align: center; line-height: 1.5; }

  canvas#camCanvas { display: none; }

  .light-meter {
    height: 8px; border-radius: 4px;
    background: #1a1a2e; overflow: hidden; margin-top: 4px;
  }
  .light-meter-fill {
    height: 100%; width: 0%; background: #2ecc71;
    transition: width 0.05s; border-radius: 4px;
  }

  .section-label {
    font-size: 0.75rem; color: #555; text-transform: uppercase;
    letter-spacing: 1px; margin-bottom: -8px;
  }
</style>
</head>
<body>
<header>
  <h1>âš¡ MORSE LIGHT</h1>
  <p>Flashlight Morse Code Communicator</p>
</header>

<div class="tabs">
  <button class="tab active" onclick="switchTab('send')">ðŸ“¡ Transmit</button>
  <button class="tab" onclick="switchTab('receive')">ðŸ“· Receive</button>
  <button class="tab" onclick="switchTab('ref')">ðŸ“– Reference</button>
</div>

<!-- TRANSMIT PANEL -->
<div id="panel-send" class="panel active">
  <p class="section-label">Message</p>
  <textarea id="msgInput" placeholder="Type your message here..." oninput="updateMorse()"></textarea>

  <p class="section-label">Morse Preview</p>
  <div class="morse-display" id="morsePreview">â€”</div>

  <div class="speed-row">
    <label>Speed: <span id="speedLabel">Medium</span></label>
    <input type="range" id="speedSlider" min="1" max="5" value="3" oninput="updateSpeedLabel()">
  </div>

  <div class="status-bar">
    <span class="status-dot" id="flashDot"></span>
    <span id="sendStatus">Ready to transmit</span>
  </div>

  <button class="main-btn btn-send" id="sendBtn" onclick="startTransmit()">âš¡ Transmit</button>
  <button class="main-btn btn-stop" id="stopBtn" onclick="stopTransmit()" style="display:none">â›” Stop</button>

  <p class="hint">Make sure your phone brightness is at max and point the camera away from the receiving phone. Keep devices ~1â€“3 feet apart in a dim environment.</p>
</div>

<!-- RECEIVE PANEL -->
<div id="panel-receive" class="panel">
  <div class="status-bar">
    <span class="status-dot" id="rxDot"></span>
    <span id="rxStatus">Press Start to begin receiving</span>
  </div>

  <div class="light-meter"><div class="light-meter-fill" id="lightMeter"></div></div>

  <p class="section-label">Decoded Morse</p>
  <div id="receive-morse">â€”</div>

  <p class="section-label">Decoded Text</p>
  <div id="receive-output">â€”</div>

  <button class="main-btn btn-receive" id="rxBtn" onclick="toggleReceive()">ðŸ“· Start Receiving</button>
  <button class="main-btn btn-stop" onclick="clearReceived()" style="margin-top:0">ðŸ—‘ Clear</button>

  <canvas id="camCanvas"></canvas>
  <video id="camVideo" autoplay playsinline style="display:none"></video>

  <p class="hint">Point this phone's camera directly at the other phone's flashlight. Works best in a dark room. Tap "Start Receiving" and wait for the other device to transmit.</p>
</div>

<!-- REFERENCE PANEL -->
<div id="panel-ref" class="panel">
  <p style="color:#888; font-size:0.9rem;">International Morse Code reference:</p>
  <div id="refGrid" style="display:grid; grid-template-columns:1fr 1fr; gap:8px; font-family:monospace;"></div>
</div>

<script>
const MORSE = {
  'A':'.-','B':'-...','C':'-.-.','D':'-..','E':'.','F':'..-.','G':'--.','H':'....','I':'..','J':'.---',
  'K':'-.-','L':'.-..','M':'--','N':'-.','O':'---','P':'.--.','Q':'--.-','R':'.-.','S':'...','T':'-',
  'U':'..-','V':'...-','W':'.--','X':'-..-','Y':'-.--','Z':'--..',
  '0':'-----','1':'.----','2':'..---','3':'...--','4':'....-','5':'.....','6':'-....','7':'--...','8':'---..','9':'----.',
  '.':'.-.-.-',',':'--..--','?':'..--..','!':'-.-.--','/':'-..-.','@':'.--.-.'
};
const MORSE_REV = Object.fromEntries(Object.entries(MORSE).map(([k,v])=>[v,k]));

// Build reference
const refGrid = document.getElementById('refGrid');
Object.entries(MORSE).forEach(([ch, code]) => {
  const el = document.createElement('div');
  el.style.cssText = 'background:#1a1a2e;padding:8px 10px;border-radius:8px;display:flex;justify-content:space-between;';
  el.innerHTML = `<span style="color:#fff;font-weight:700">${ch}</span><span style="color:#4f8ef7">${code}</span>`;
  refGrid.appendChild(el);
});

function textToMorse(txt) {
  return txt.toUpperCase().split('').map(c => {
    if (c === ' ') return '/';
    return MORSE[c] || '';
  }).filter(x => x !== '').join(' ');
}

function updateMorse() {
  const txt = document.getElementById('msgInput').value;
  document.getElementById('morsePreview').textContent = textToMorse(txt) || 'â€”';
}

const speedLabels = ['Very Slow','Slow','Medium','Fast','Very Fast'];
const speedDots = [300, 200, 130, 80, 50]; // ms per dot unit

function updateSpeedLabel() {
  const v = parseInt(document.getElementById('speedSlider').value) - 1;
  document.getElementById('speedLabel').textContent = speedLabels[v];
}

// Transmit
let torchStream = null;
let transmitting = false;
let stopRequested = false;

async function getTorch() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'environment', advanced: [{ torch: true }] }
    });
    const track = stream.getVideoTracks()[0];
    return { stream, track };
  } catch(e) {
    return null;
  }
}

async function setTorch(track, on) {
  try {
    await track.applyConstraints({ advanced: [{ torch: on }] });
  } catch(e) {}
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

async function startTransmit() {
  const txt = document.getElementById('msgInput').value.trim();
  if (!txt) { alert('Please enter a message.'); return; }

  const morse = textToMorse(txt);
  if (!morse) return;

  document.getElementById('sendBtn').style.display = 'none';
  document.getElementById('stopBtn').style.display = 'block';
  document.getElementById('sendStatus').textContent = 'Acquiring torch...';

  const result = await getTorch();
  if (!result) {
    document.getElementById('sendStatus').textContent = 'Torch not available on this device/browser.';
    resetSendUI();
    return;
  }
  const { stream, track } = result;
  torchStream = stream;
  transmitting = true;
  stopRequested = false;

  const speed = speedDots[parseInt(document.getElementById('speedSlider').value) - 1];
  const dot = speed;
  const dash = speed * 3;
  const symGap = speed;
  const charGap = speed * 3;
  const wordGap = speed * 7;

  const flashDot = document.getElementById('flashDot');
  const sendStatus = document.getElementById('sendStatus');

  // Send a preamble: 3 short flashes so receiver can calibrate
  sendStatus.textContent = 'Sending calibration...';
  for (let i = 0; i < 3; i++) {
    if (stopRequested) break;
    await setTorch(track, true); flashDot.classList.add('on');
    await sleep(dot);
    await setTorch(track, false); flashDot.classList.remove('on');
    await sleep(dot);
  }
  await sleep(charGap);

  const tokens = morse.split(' ');
  for (let t = 0; t < tokens.length; t++) {
    if (stopRequested) break;
    const token = tokens[t];
    if (token === '/') {
      sendStatus.textContent = `Word gap...`;
      await sleep(wordGap - charGap); // already have char gap from previous
      continue;
    }
    sendStatus.textContent = `Sending: ${token}`;
    for (let s = 0; s < token.length; s++) {
      if (stopRequested) break;
      const sym = token[s];
      await setTorch(track, true); flashDot.classList.add('on');
      await sleep(sym === '.' ? dot : dash);
      await setTorch(track, false); flashDot.classList.remove('on');
      if (s < token.length - 1) await sleep(symGap);
    }
    if (t < tokens.length - 1 && tokens[t+1] !== '/') await sleep(charGap);
    else if (tokens[t+1] === '/') await sleep(charGap);
  }

  await setTorch(track, false);
  flashDot.classList.remove('on');
  stream.getTracks().forEach(t => t.stop());
  torchStream = null;
  transmitting = false;
  sendStatus.textContent = stopRequested ? 'Stopped.' : 'Transmission complete!';
  resetSendUI();
}

function stopTransmit() {
  stopRequested = true;
}

function resetSendUI() {
  document.getElementById('sendBtn').style.display = 'block';
  document.getElementById('stopBtn').style.display = 'none';
}

// --- RECEIVE ---
let rxActive = false;
let rxStream = null;
let rxInterval = null;
let rxHistory = [];
let rxMorseBuffer = '';
let rxTextBuffer = '';
let lastBrightness = 0;
let lightOn = false;
let lightOnTime = 0;
let lightOffTime = 0;
let baselineSet = false;
let baselineLow = 999;
let baselineHigh = 0;
let charTimer = null;
let wordTimer = null;
let dotUnit = 100; // will auto-calibrate
let calibSamples = [];
let calibrating = true;
let calibFrames = 0;

const video = document.getElementById('camVideo');
const canvas = document.getElementById('camCanvas');
const ctx = canvas.getContext('2d');

async function toggleReceive() {
  if (!rxActive) {
    await startReceive();
  } else {
    stopReceive();
  }
}

async function startReceive() {
  try {
    rxStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'environment', width: 32, height: 32 }
    });
    video.srcObject = rxStream;
    canvas.width = 32; canvas.height = 32;
    rxActive = true;
    document.getElementById('rxBtn').textContent = 'â›” Stop Receiving';
    document.getElementById('rxBtn').classList.add('recording');
    document.getElementById('rxStatus').textContent = 'Calibrating... (aim at light source)';
    document.getElementById('rxDot').classList.add('on');
    calibrating = true;
    calibFrames = 0;
    calibSamples = [];
    baselineLow = 999; baselineHigh = 0;
    lightOn = false;
    rxMorseBuffer = '';
    rxTextBuffer = '';
    rxInterval = setInterval(processFrame, 50);
  } catch(e) {
    alert('Camera access denied or unavailable.');
  }
}

function stopReceive() {
  rxActive = false;
  clearInterval(rxInterval);
  if (rxStream) rxStream.getTracks().forEach(t => t.stop());
  rxStream = null;
  document.getElementById('rxBtn').textContent = 'ðŸ“· Start Receiving';
  document.getElementById('rxBtn').classList.remove('recording');
  document.getElementById('rxStatus').textContent = 'Stopped.';
  document.getElementById('rxDot').classList.remove('on');
  document.getElementById('lightMeter').style.width = '0%';
}

function getBrightness() {
  ctx.drawImage(video, 0, 0, 32, 32);
  const data = ctx.getImageData(8, 8, 16, 16).data;
  let sum = 0;
  for (let i = 0; i < data.length; i += 4) {
    sum += (data[i] * 0.299 + data[i+1] * 0.587 + data[i+2] * 0.114);
  }
  return sum / (data.length / 4);
}

function processFrame() {
  let b;
  try { b = getBrightness(); } catch(e) { return; }

  const now = Date.now();

  if (calibrating) {
    calibSamples.push(b);
    calibFrames++;
    if (b < baselineLow) baselineLow = b;
    if (b > baselineHigh) baselineHigh = b;
    if (calibFrames >= 30) { // ~1.5s
      calibrating = false;
      document.getElementById('rxStatus').textContent = 'Listening...';
    }
    return;
  }

  // Dynamic threshold
  const range = baselineHigh - baselineLow;
  const threshold = baselineLow + Math.max(range * 0.4, 15);

  // Update meter
  const pct = Math.min(100, Math.max(0, ((b - baselineLow) / Math.max(range, 20)) * 100));
  document.getElementById('lightMeter').style.width = pct + '%';

  // Update baseline slowly
  if (b < baselineLow + 5) baselineLow = baselineLow * 0.98 + b * 0.02;

  const isOn = b > threshold;

  if (isOn && !lightOn) {
    // Rising edge
    lightOn = true;
    const offDur = now - lightOffTime;
    lightOnTime = now;
    clearTimeout(charTimer);
    clearTimeout(wordTimer);

    if (lightOffTime > 0 && offDur > 0) {
      // Classify gap
      if (offDur > dotUnit * 5) {
        // word gap
        flushChar();
        flushWord();
      } else if (offDur > dotUnit * 2) {
        // char gap
        flushChar();
      }
      // else symbol gap, do nothing
    }
  } else if (!isOn && lightOn) {
    // Falling edge
    lightOn = false;
    const onDur = now - lightOnTime;
    lightOffTime = now;

    // Classify symbol
    const sym = onDur > dotUnit * 2 ? '-' : '.';
    rxMorseBuffer += sym;

    // Auto-calibrate dot unit from first few symbols
    if (sym === '.' && dotUnit === 100 && onDur > 20) {
      dotUnit = Math.round(onDur * 1.2);
    }

    document.getElementById('receive-morse').textContent =
      (rxTextBuffer ? rxTextBuffer + ' | ' : '') + rxMorseBuffer || 'â€”';

    // Set char timer
    charTimer = setTimeout(() => { flushChar(); }, dotUnit * 3.5);
    wordTimer = setTimeout(() => { flushWord(); }, dotUnit * 7);
  }

  // Visual indicator
  document.getElementById('rxDot').style.background = isOn ? '#ffe066' : '';
  document.getElementById('rxDot').style.boxShadow = isOn ? '0 0 10px #ffe066' : '';
}

function flushChar() {
  if (!rxMorseBuffer) return;
  const ch = MORSE_REV[rxMorseBuffer] || '?';
  rxTextBuffer += ch;
  document.getElementById('receive-output').textContent = rxTextBuffer || 'â€”';
  rxMorseBuffer = '';
}

function flushWord() {
  flushChar();
  rxTextBuffer += ' ';
  document.getElementById('receive-output').textContent = rxTextBuffer.trim() || 'â€”';
}

function clearReceived() {
  rxMorseBuffer = '';
  rxTextBuffer = '';
  document.getElementById('receive-morse').textContent = 'â€”';
  document.getElementById('receive-output').textContent = 'â€”';
  calibrating = true;
  calibFrames = 0;
  calibSamples = [];
  baselineLow = 999; baselineHigh = 0;
  dotUnit = 100;
  if (rxActive) document.getElementById('rxStatus').textContent = 'Calibrating...';
}

function switchTab(tab) {
  document.querySelectorAll('.tab').forEach((t,i) => {
    t.classList.toggle('active', ['send','receive','ref'][i] === tab);
  });
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.getElementById('panel-' + tab).classList.add('active');
}
</script>
</body>
</html>