<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<title>Morse Flashlight</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: #0a0a0f;
    color: #e0e0e0;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }
  header { text-align: center; padding: 24px 16px 12px; }
  header h1 { font-size: 1.6rem; letter-spacing: 2px; color: #fff; }
  header p { font-size: 0.8rem; color: #888; margin-top: 4px; }

  .tabs {
    display: flex; margin: 0 16px;
    border-radius: 12px; overflow: hidden; background: #1a1a2e;
  }
  .tab {
    flex: 1; padding: 12px; text-align: center;
    cursor: pointer; font-size: 0.95rem; font-weight: 600;
    color: #888; transition: all 0.2s;
    border: none; background: transparent;
  }
  .tab.active { background: #4f8ef7; color: #fff; border-radius: 12px; }

  .panel { display: none; padding: 20px 16px; flex-direction: column; gap: 16px; }
  .panel.active { display: flex; }

  textarea {
    width: 100%; padding: 14px; border-radius: 12px;
    background: #1a1a2e; border: 1px solid #2a2a4a;
    color: #fff; font-size: 1rem; resize: none; height: 100px; outline: none;
  }
  textarea:focus { border-color: #4f8ef7; }

  .morse-display {
    background: #1a1a2e; border-radius: 12px; padding: 14px;
    font-family: monospace; font-size: 1.1rem; letter-spacing: 3px;
    color: #4f8ef7; min-height: 50px; word-break: break-all; line-height: 1.8;
  }

  .speed-row { display: flex; align-items: center; gap: 12px; }
  .speed-row label { font-size: 0.85rem; color: #888; white-space: nowrap; }
  input[type=range] { flex: 1; accent-color: #4f8ef7; }

  button.main-btn {
    padding: 16px; border-radius: 14px; border: none;
    font-size: 1.1rem; font-weight: 700; cursor: pointer;
    transition: all 0.15s; width: 100%;
  }
  .btn-send { background: #4f8ef7; color: #fff; }
  .btn-send:active { background: #2d6ed6; }
  .btn-send:disabled { background: #2a2a4a; color: #555; cursor: default; }
  .btn-stop { background: #e74c3c; color: #fff; }
  .btn-receive { background: #2ecc71; color: #fff; }
  .btn-receive.recording { background: #e74c3c; }

  .status-dot {
    width: 12px; height: 12px; border-radius: 50%;
    background: #333; display: inline-block; margin-right: 8px; transition: background 0.1s;
  }
  .status-dot.on { background: #ffe066; box-shadow: 0 0 10px #ffe066; }

  .status-bar {
    display: flex; align-items: center; padding: 10px 14px;
    background: #1a1a2e; border-radius: 10px; font-size: 0.9rem;
  }

  #receive-output {
    background: #1a1a2e; border-radius: 12px; padding: 14px;
    min-height: 80px; font-size: 1.1rem; color: #2ecc71;
    word-break: break-word; line-height: 1.7;
  }
  #receive-morse {
    background: #1a1a2e; border-radius: 12px; padding: 14px;
    font-family: monospace; font-size: 1rem; color: #888;
    min-height: 40px; word-break: break-all; letter-spacing: 2px;
  }

  .hint { font-size: 0.78rem; color: #555; text-align: center; line-height: 1.5; }
  canvas#camCanvas { display: none; }

  .light-meter { height: 8px; border-radius: 4px; background: #1a1a2e; overflow: hidden; margin-top: 4px; }
  .light-meter-fill { height: 100%; width: 0%; background: #2ecc71; transition: width 0.05s; border-radius: 4px; }

  .section-label { font-size: 0.75rem; color: #555; text-transform: uppercase; letter-spacing: 1px; margin-bottom: -8px; }

  .device-badge {
    text-align: center; font-size: 0.75rem; padding: 4px 10px;
    background: #1a1a2e; border-radius: 20px; color: #555; margin: 0 auto;
    width: fit-content;
  }
</style>
</head>
<body>
<header>
  <h1>âš¡ MORSE LIGHT</h1>
  <p>Flashlight Morse Code Communicator <br> Now Supporting Android! </p>
</header>
<div class="device-badge" id="deviceBadge">Detecting device...</div>

<br>
<div class="tabs">
  <button class="tab active" onclick="switchTab('send')">ðŸ“¡ Transmit</button>
  <button class="tab" onclick="switchTab('receive')">ðŸ“· Receive</button>
  <button class="tab" onclick="switchTab('ref')">ðŸ“– Reference</button>
</div>

<!-- TRANSMIT PANEL -->
<div id="panel-send" class="panel active">
  <p class="section-label">Message</p>
  <textarea id="msgInput" placeholder="Type your message here..." oninput="updateMorse()"></textarea>

  <p class="section-label">Morse Preview</p>
  <div class="morse-display" id="morsePreview">â€”</div>

  <div class="speed-row">
    <label>Speed: <span id="speedLabel">Medium</span></label>
    <input type="range" id="speedSlider" min="1" max="5" value="3" oninput="updateSpeedLabel()">
  </div>

  <div class="status-bar">
    <span class="status-dot" id="flashDot"></span>
    <span id="sendStatus">Ready to transmit</span>
  </div>

  <button class="main-btn btn-send" id="sendBtn" onclick="startTransmit()">âš¡ Transmit</button>
  <button class="main-btn btn-stop" id="stopBtn" onclick="stopTransmit()" style="display:none">â›” Stop</button>

  <p class="hint">Keep screen brightness at max. Point the camera end of your phone toward the receiving device. Works best in a dim room, ~1â€“3 feet apart.</p>
</div>

<!-- RECEIVE PANEL -->
<div id="panel-receive" class="panel">
  <div class="status-bar">
    <span class="status-dot" id="rxDot"></span>
    <span id="rxStatus">Press Start to begin receiving</span>
  </div>

  <div class="light-meter"><div class="light-meter-fill" id="lightMeter"></div></div>

  <p class="section-label">Decoded Morse</p>
  <div id="receive-morse">â€”</div>

  <p class="section-label">Decoded Text</p>
  <div id="receive-output">â€”</div>

  <button class="main-btn btn-receive" id="rxBtn" onclick="toggleReceive()">ðŸ“· Start Receiving</button>
  <button class="main-btn btn-stop" onclick="clearReceived()" style="margin-top:0">ðŸ—‘ Clear</button>

  <canvas id="camCanvas"></canvas>
  <video id="camVideo" autoplay playsinline muted style="display:none"></video>

  <p class="hint">Point this phone's camera at the other phone's flashlight. Tap Start, wait for "Listening...", then have the other device transmit.</p>
</div>

<!-- REFERENCE PANEL -->
<div id="panel-ref" class="panel">
  <p style="color:#888; font-size:0.9rem;">International Morse Code reference:</p>
  <div id="refGrid" style="display:grid; grid-template-columns:1fr 1fr; gap:8px; font-family:monospace;"></div>
</div>

<script>
// â”€â”€ Morse tables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MORSE = {
  'A':'.-','B':'-...','C':'-.-.','D':'-..','E':'.','F':'..-.','G':'--.','H':'....','I':'..','J':'.---',
  'K':'-.-','L':'.-..','M':'--','N':'-.','O':'---','P':'.--.','Q':'--.-','R':'.-.','S':'...','T':'-',
  'U':'..-','V':'...-','W':'.--','X':'-..-','Y':'-.--','Z':'--..',
  '0':'-----','1':'.----','2':'..---','3':'...--','4':'....-','5':'.....','6':'-....','7':'--...','8':'---..','9':'----.',
  '.':'.-.-.-',',':'--..--','?':'..--..','!':'-.-.--','/':'-..-.','@':'.--.-.'
};
const MORSE_REV = Object.fromEntries(Object.entries(MORSE).map(([k,v])=>[v,k]));

// â”€â”€ Device detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
const isAndroid = /Android/.test(navigator.userAgent);
document.getElementById('deviceBadge').textContent =
  isIOS ? 'ðŸŽ iOS Device' : isAndroid ? 'ðŸ¤– Android Device' : 'ðŸ’» Desktop Browser';

// â”€â”€ Reference grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const refGrid = document.getElementById('refGrid');
Object.entries(MORSE).forEach(([ch, code]) => {
  const el = document.createElement('div');
  el.style.cssText = 'background:#1a1a2e;padding:8px 10px;border-radius:8px;display:flex;justify-content:space-between;';
  el.innerHTML = `<span style="color:#fff;font-weight:700">${ch}</span><span style="color:#4f8ef7">${code}</span>`;
  refGrid.appendChild(el);
});

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function textToMorse(txt) {
  return txt.toUpperCase().split('').map(c => {
    if (c === ' ') return '/';
    return MORSE[c] || '';
  }).filter(x => x !== '').join(' ');
}
function updateMorse() {
  document.getElementById('morsePreview').textContent = textToMorse(document.getElementById('msgInput').value) || 'â€”';
}
const speedLabels = ['Very Slow','Slow','Medium','Fast','Very Fast'];
const speedDots   = [300, 200, 130, 80, 50];
function updateSpeedLabel() {
  document.getElementById('speedLabel').textContent = speedLabels[+document.getElementById('speedSlider').value - 1];
}
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// â”€â”€ Wake Lock (keeps screen on during transmit on Android/iOS) â”€
let wakeLock = null;
async function requestWakeLock() {
  if ('wakeLock' in navigator) {
    try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e) {}
  }
}
function releaseWakeLock() {
  if (wakeLock) { wakeLock.release(); wakeLock = null; }
}

// â”€â”€ Torch helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function getTorchTrack() {
  // Try rear camera with torch
  const constraints = [
    // Android Chrome style
    { video: { facingMode: { exact: 'environment' } } },
    // iOS / fallback
    { video: { facingMode: 'environment' } },
    // last resort
    { video: true }
  ];
  for (const c of constraints) {
    try {
      const stream = await navigator.mediaDevices.getUserMedia(c);
      const track = stream.getVideoTracks()[0];
      const caps = track.getCapabilities ? track.getCapabilities() : {};
      // Check torch support
      if (caps.torch) {
        return { stream, track, torchSupported: true };
      }
      // Some Android devices expose torch only after apply
      try {
        await track.applyConstraints({ advanced: [{ torch: false }] });
        return { stream, track, torchSupported: true };
      } catch(e) {
        // torch not supported on this track, try next
        stream.getTracks().forEach(t => t.stop());
      }
    } catch(e) { /* try next */ }
  }
  return null;
}

async function setTorch(track, on) {
  try {
    await track.applyConstraints({ advanced: [{ torch: on }] });
  } catch(e) {}
}

// â”€â”€ Transmit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let stopRequested = false;

async function startTransmit() {
  const txt = document.getElementById('msgInput').value.trim();
  if (!txt) { alert('Please enter a message first.'); return; }
  const morse = textToMorse(txt);
  if (!morse) return;

  document.getElementById('sendBtn').style.display = 'none';
  document.getElementById('stopBtn').style.display = 'block';
  document.getElementById('sendStatus').textContent = 'Requesting torch...';
  stopRequested = false;

  await requestWakeLock();

  const result = await getTorchTrack();
  if (!result || !result.torchSupported) {
    document.getElementById('sendStatus').textContent = 'âš ï¸ Torch not available. Try Chrome on Android or Safari on iOS.';
    resetSendUI(); releaseWakeLock(); return;
  }
  const { stream, track } = result;

  const dot  = speedDots[+document.getElementById('speedSlider').value - 1];
  const dash = dot * 3, symGap = dot, charGap = dot * 3, wordGap = dot * 7;
  const flashDot   = document.getElementById('flashDot');
  const sendStatus = document.getElementById('sendStatus');

  const flash = async (dur) => {
    await setTorch(track, true);  flashDot.classList.add('on');
    await sleep(dur);
    await setTorch(track, false); flashDot.classList.remove('on');
  };

  // Preamble: 5 dots so receiver can calibrate timing
  sendStatus.textContent = 'Sending calibration pulses...';
  for (let i = 0; i < 5 && !stopRequested; i++) {
    await flash(dot);
    await sleep(dot);
  }
  await sleep(charGap);

  const tokens = morse.split(' ');
  for (let t = 0; t < tokens.length && !stopRequested; t++) {
    const token = tokens[t];
    if (token === '/') { await sleep(wordGap - charGap); continue; }
    sendStatus.textContent = `Sending: ${token}`;
    for (let s = 0; s < token.length && !stopRequested; s++) {
      await flash(token[s] === '.' ? dot : dash);
      if (s < token.length - 1) await sleep(symGap);
    }
    if (t < tokens.length - 1 && tokens[t + 1] !== '/') await sleep(charGap);
    else if (tokens[t + 1] === '/') await sleep(charGap);
  }

  await setTorch(track, false);
  flashDot.classList.remove('on');
  stream.getTracks().forEach(t => t.stop());
  releaseWakeLock();
  sendStatus.textContent = stopRequested ? 'Stopped.' : 'âœ… Transmission complete!';
  resetSendUI();
}

function stopTransmit() { stopRequested = true; }
function resetSendUI() {
  document.getElementById('sendBtn').style.display = 'block';
  document.getElementById('stopBtn').style.display = 'none';
}

// â”€â”€ Receive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let rxActive = false, rxStream = null, rxInterval = null;
let rxMorseBuffer = '', rxTextBuffer = '';
let lightOn = false, lightOnTime = 0, lightOffTime = 0;
let baselineLow = 999, baselineHigh = 0;
let calibrating = true, calibFrames = 0;
let dotUnit = 130;
let charTimer = null, wordTimer = null;

const video  = document.getElementById('camVideo');
const canvas = document.getElementById('camCanvas');
const ctx    = canvas.getContext('2d');

async function toggleReceive() {
  rxActive ? stopReceive() : await startReceive();
}

async function startReceive() {
  try {
    // Request rear camera; muted is important on some Android versions
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: 'environment' }, width: { ideal: 64 }, height: { ideal: 64 } },
      audio: false
    });
    video.srcObject = stream;
    await video.play().catch(()=>{});
    canvas.width = 64; canvas.height = 64;
    rxStream  = stream;
    rxActive  = true;
    calibrating  = true;
    calibFrames  = 0;
    baselineLow  = 999; baselineHigh = 0;
    lightOn      = false; lightOffTime = 0;
    dotUnit      = 130;
    rxMorseBuffer = ''; rxTextBuffer = '';

    document.getElementById('rxBtn').textContent = 'â›” Stop Receiving';
    document.getElementById('rxBtn').classList.add('recording');
    document.getElementById('rxStatus').textContent = 'Calibrating... (aim at the flashlight)';
    document.getElementById('rxDot').classList.add('on');

    rxInterval = setInterval(processFrame, 50);
  } catch(e) {
    alert('Camera access denied or unavailable. Please allow camera permission and try again.');
  }
}

function stopReceive() {
  rxActive = false;
  clearInterval(rxInterval);
  clearTimeout(charTimer); clearTimeout(wordTimer);
  if (rxStream) rxStream.getTracks().forEach(t => t.stop());
  rxStream = null;
  document.getElementById('rxBtn').textContent = 'ðŸ“· Start Receiving';
  document.getElementById('rxBtn').classList.remove('recording');
  document.getElementById('rxStatus').textContent = 'Stopped.';
  document.getElementById('rxDot').classList.remove('on');
  document.getElementById('lightMeter').style.width = '0%';
}

function getBrightness() {
  ctx.drawImage(video, 0, 0, 64, 64);
  const d = ctx.getImageData(16, 16, 32, 32).data;
  let sum = 0;
  for (let i = 0; i < d.length; i += 4)
    sum += d[i] * 0.299 + d[i+1] * 0.587 + d[i+2] * 0.114;
  return sum / (d.length / 4);
}

function processFrame() {
  let b;
  try { b = getBrightness(); } catch(e) { return; }
  const now = Date.now();

  if (calibrating) {
    if (b < baselineLow)  baselineLow  = b;
    if (b > baselineHigh) baselineHigh = b;
    calibFrames++;
    if (calibFrames >= 30) {
      calibrating = false;
      document.getElementById('rxStatus').textContent = 'Listening...';
    }
    return;
  }

  // Adaptive threshold â€” midpoint between observed dark/light
  const range = baselineHigh - baselineLow;
  const threshold = baselineLow + Math.max(range * 0.45, 12);

  // Update dark baseline slowly
  if (b < threshold) baselineLow = baselineLow * 0.97 + b * 0.03;

  const isOn = b > threshold;

  // Light meter
  document.getElementById('lightMeter').style.width =
    Math.min(100, Math.max(0, ((b - baselineLow) / Math.max(range, 20)) * 100)) + '%';

  // Rising edge
  if (isOn && !lightOn) {
    lightOn = true;
    clearTimeout(charTimer); clearTimeout(wordTimer);
    const offDur = lightOffTime > 0 ? now - lightOffTime : 0;
    if (offDur > dotUnit * 5)       { flushChar(); flushWord(); }
    else if (offDur > dotUnit * 2)  { flushChar(); }
    lightOnTime = now;
  }
  // Falling edge
  else if (!isOn && lightOn) {
    lightOn = false;
    const onDur = now - lightOnTime;
    lightOffTime = now;

    const sym = onDur > dotUnit * 2 ? '-' : '.';
    rxMorseBuffer += sym;

    // Auto-calibrate dot unit from short pulses
    if (sym === '.' && onDur > 20 && onDur < dotUnit * 2) {
      dotUnit = Math.round(dotUnit * 0.8 + onDur * 1.2 * 0.2);
    }

    document.getElementById('receive-morse').textContent =
      (rxTextBuffer ? '[' + rxTextBuffer.trim() + '] ' : '') + rxMorseBuffer || 'â€”';

    charTimer = setTimeout(() => flushChar(), dotUnit * 3.5);
    wordTimer = setTimeout(() => flushWord(), dotUnit * 7);
  }

  // Visual flash indicator
  const dot = document.getElementById('rxDot');
  dot.style.background   = isOn ? '#ffe066' : '#333';
  dot.style.boxShadow    = isOn ? '0 0 10px #ffe066' : 'none';
  document.getElementById('rxStatus').textContent = isOn ? 'ðŸ”¦ Flash detected!' : 'Listening...';
}

function flushChar() {
  if (!rxMorseBuffer) return;
  rxTextBuffer += MORSE_REV[rxMorseBuffer] || '?';
  document.getElementById('receive-output').textContent = rxTextBuffer.trim() || 'â€”';
  rxMorseBuffer = '';
  document.getElementById('receive-morse').textContent = rxMorseBuffer || 'â€”';
}
function flushWord() {
  flushChar();
  rxTextBuffer += ' ';
  document.getElementById('receive-output').textContent = rxTextBuffer.trim() || 'â€”';
}
function clearReceived() {
  clearTimeout(charTimer); clearTimeout(wordTimer);
  rxMorseBuffer = ''; rxTextBuffer = '';
  document.getElementById('receive-morse').textContent = 'â€”';
  document.getElementById('receive-output').textContent = 'â€”';
  baselineLow = 999; baselineHigh = 0; dotUnit = 130;
  calibrating = true; calibFrames = 0;
  if (rxActive) document.getElementById('rxStatus').textContent = 'Calibrating...';
}

function switchTab(tab) {
  document.querySelectorAll('.tab').forEach((t,i) =>
    t.classList.toggle('active', ['send','receive','ref'][i] === tab));
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.getElementById('panel-' + tab).classList.add('active');
}
</script>
</body>
</html>
